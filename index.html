<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的錢錢 V91 - 手機選單修復版</title>
    
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
        // Global Error Handler
        window.onerror = function(msg, url, line, col, error) {
            if (msg.includes('ResizeObserver loop')) return false;
            console.error('Global Error:', msg, error);
            var btn = document.getElementById('crash-rescue-btn');
            if(btn) { 
                btn.style.display = 'block'; 
                btn.innerText = "⚠️ 程式發生錯誤 (點此重置): " + msg; 
            }
            return false;
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif; background-color: #f8fafc; color: #333; }
        .card { @apply bg-white p-6 rounded-2xl shadow-sm border border-gray-100 transition hover:shadow-md; }
        .input-label { @apply block text-xs font-bold text-gray-500 mb-1 ml-1; }
        .input-field { @apply w-full rounded-lg border-gray-300 bg-gray-50 text-sm focus:border-pink-400 focus:ring-pink-300 border p-2.5 transition; }
        .btn-primary { @apply inline-flex justify-center items-center rounded-lg bg-gradient-to-r from-pink-500 to-rose-500 py-2 px-4 text-sm font-medium text-white shadow-lg shadow-pink-500/30 hover:shadow-pink-500/50 hover:from-pink-600 hover:to-rose-600 focus:outline-none transition transform active:scale-95; }
        .btn-secondary { @apply inline-flex justify-center items-center rounded-lg border border-gray-200 bg-white py-2 px-4 text-sm font-medium text-gray-600 hover:bg-gray-50 focus:outline-none transition; }
        .btn-success { @apply inline-flex justify-center items-center rounded-lg bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-md hover:bg-green-700 focus:outline-none transition; }
        .btn-warning { @apply inline-flex justify-center items-center rounded-lg bg-amber-500 py-2 px-4 text-sm font-medium text-white shadow-md hover:bg-amber-600 focus:outline-none transition; }
        .btn-cloud { @apply inline-flex justify-center items-center rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 py-2 px-4 text-sm font-medium text-white shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:from-blue-600 hover:to-cyan-600 focus:outline-none transition transform active:scale-95; }
        .text-up { color: #ef4444; } .text-down { color: #22c55e; }
        .fa-spin-fast { animation: fa-spin 1s infinite linear; }
        .div-input { @apply w-full text-center border border-gray-300 rounded-md p-1.5 text-sm bg-white focus:border-pink-500 focus:ring-2 focus:ring-pink-200 outline-none transition shadow-sm; }
        .div-label { @apply text-xs text-gray-500 text-center mb-1.5 font-bold block; }
        .asset-excluded { @apply opacity-60 bg-gray-50 grayscale; }
        .badge-excluded { @apply bg-gray-200 text-gray-500 text-[10px] px-1.5 py-0.5 rounded font-bold ml-2; }
        #crash-rescue-btn { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: #ef4444; color: white; padding: 20px; font-size: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .status-offline { background-color: #ef4444; }
        #fileInput { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Mobile transition */
        .mobile-menu-enter-active, .mobile-menu-leave-active { transition: transform 0.3s ease; }
        .mobile-menu-enter-from, .mobile-menu-leave-to { transform: translateX(-100%); }
    </style>
</head>
<body>

<button id="crash-rescue-btn" onclick="if(confirm('是否重置所有資料以修復？')){localStorage.clear();location.reload();}">程式發生錯誤，點此重置</button>

<div id="app" class="flex h-screen overflow-hidden">
    <input type="file" id="fileInput" accept=".json" @change="handleFileUpload" class="hidden">

    <!-- Mobile Overlay -->
    <div v-if="isMobileMenuOpen" class="fixed inset-0 bg-black/50 z-30 md:hidden" @click="isMobileMenuOpen = false"></div>

    <!-- Sidebar (Responsive) -->
    <div :class="[
        'bg-slate-800 text-white flex flex-col h-full shrink-0 transition-transform duration-300 ease-in-out z-40',
        'fixed inset-y-0 left-0 w-64 shadow-2xl md:shadow-none md:relative md:translate-x-0',
        isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'
    ]">
        <div class="p-6 text-2xl font-bold text-pink-400 flex items-center justify-between tracking-wide shrink-0">
            <div class="flex items-center">
                <i class="fa-solid fa-sack-dollar mr-2"></i> 我的錢錢
                <span class="text-[10px] ml-auto bg-slate-700 px-2 py-0.5 rounded text-gray-300 ml-2">V91</span>
            </div>
            <!-- Close button for mobile -->
            <button @click="isMobileMenuOpen = false" class="md:hidden text-slate-400 hover:text-white">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <nav class="flex-1 px-4 space-y-3 mt-2 overflow-y-auto custom-scrollbar">
            <div role="button" @click="selectTab('dashboard')" :class="tabClass('dashboard')"><i class="fa-solid fa-chart-pie w-6 text-center"></i> 資產總覽</div>
            <div role="button" @click="selectTab('passive')" :class="tabClass('passive')"><i class="fa-solid fa-hand-holding-dollar w-6 text-center"></i> 被動收入</div>
            <div role="button" @click="selectTab('portfolio')" :class="tabClass('portfolio')"><i class="fa-solid fa-list-ul w-6 text-center"></i> 資產明細</div>
            <div role="button" @click="selectTab('history')" :class="tabClass('history')"><i class="fa-solid fa-clock-rotate-left w-6 text-center"></i> 年度回顧</div>
            <div class="mt-8 border-t border-slate-700 pt-4">
                <div role="button" @click="selectTab('settings')" :class="tabClass('settings')">
                    <i class="fa-solid fa-gear w-6 text-center"></i> 系統設定
                    <span v-if="user" class="ml-auto w-2 h-2 rounded-full bg-green-400 box-content border-2 border-slate-800"></span>
                </div>
            </div>
        </nav>
        
        <div v-if="user" class="p-4 text-xs text-slate-400 bg-slate-900/50 shrink-0">
            <i class="fa-solid fa-cloud text-blue-400 mr-1"></i> 已連線
            <div class="truncate opacity-50 mt-1">{{ syncId ? 'ID: ' + syncId : user.uid.substring(0, 8) + '...' }}</div>
        </div>
    </div>

    <div class="flex-1 flex flex-col overflow-y-auto bg-[#f8fafc]">
        <!-- Mobile Header with Hamburger -->
        <header class="bg-white shadow-sm p-4 md:hidden flex justify-between items-center sticky top-0 z-20">
            <div class="flex items-center">
                <button @click="isMobileMenuOpen = true" class="text-gray-600 mr-4 focus:outline-none">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <div class="font-bold text-lg text-slate-700">我的錢錢 V91</div>
            </div>
            <div class="flex space-x-4 text-lg">
                <button @click="selectTab('settings')" class="text-gray-500 relative">
                    <i class="fa-solid fa-gear"></i>
                    <span v-if="user" class="absolute -top-1 -right-1 w-2 h-2 rounded-full bg-green-500 border border-white"></span>
                </button>
            </div>
        </header>

        <main class="p-4 md:p-8 space-y-6 max-w-7xl mx-auto w-full pb-20">
            <!-- Dashboard Tab -->
            <div v-if="currentTab === 'dashboard'" class="space-y-6 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card bg-gradient-to-br from-indigo-600 to-blue-700 text-white border-none relative overflow-hidden">
                        <div class="absolute right-4 top-4 opacity-20"><i class="fa-solid fa-wallet text-6xl"></i></div>
                        <div class="text-blue-100 text-sm font-medium">淨資產總額 (已扣除未計入)</div>
                        <div class="text-5xl font-bold mt-2 tracking-tight">${{ formatNumber(netWorth) }}</div>
                        <div class="mt-4 text-sm bg-white/20 px-3 py-1 rounded-full inline-block backdrop-blur-sm">損益: <span :class="totalProfitLoss>=0?'text-green-300':'text-red-300'">{{ formatNumber(totalProfitLoss) }}</span></div>
                    </div>
                    <div class="card border-l-4 border-pink-500 relative overflow-hidden">
                         <div class="absolute right-4 top-4 text-pink-100"><i class="fa-solid fa-money-bill-wheat text-6xl"></i></div>
                         <div class="text-gray-500 text-sm font-bold">預估年被動收入</div>
                         <div class="text-4xl font-bold text-slate-800 mt-2">${{ formatNumber(annualPassiveIncome) }}</div>
                         <div class="mt-4 pt-4 border-t text-sm text-gray-500 flex justify-between items-center"><span>平均月領</span><span class="font-bold text-pink-600 text-xl">${{ formatNumber(annualPassiveIncome / 12) }}</span></div>
                    </div>
                </div>
                <div class="card mt-6"><h3 class="font-bold mb-6 text-slate-700 text-lg border-b pb-2"><i class="fa-solid fa-chart-pie mr-2 text-indigo-500"></i>資產分佈</h3><div class="h-[500px] flex justify-center items-center"><canvas id="mainPieChart"></canvas></div></div>
            </div>

            <!-- Passive Tab -->
            <div v-if="currentTab === 'passive'" class="space-y-6 animate-fade-in">
                <div class="card"><h3 class="font-bold mb-6 text-slate-700">每月現金流預估</h3><div class="h-72"><canvas id="monthlyBarChart"></canvas></div></div>
                <div class="card overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-xs font-bold text-slate-500"><tr><th class="px-4 py-3">名稱</th><th class="px-4 py-3">頻率</th><th class="px-4 py-3">總配息</th><th class="px-4 py-3">台幣年收</th><th class="px-4 py-3 text-right">殖利率</th></tr></thead><tbody><tr v-for="item in passiveIncomeList" :key="item.id" class="border-b hover:bg-gray-50"><td class="px-4 py-3 font-bold">{{ item.name }}</td><td class="px-4 py-3 text-xs">{{ item.freq }}</td><td class="px-4 py-3 text-gray-500 font-mono">{{ item.currency }} {{ formatNumber(item.totalDiv, 2) }}</td><td class="px-4 py-3 font-bold text-slate-800">NT$ {{ formatNumber(item.annualIncome) }}</td><td class="px-4 py-3 text-right text-green-600 font-bold">{{ item.yield }}%</td></tr></tbody></table><div v-if="passiveIncomeList.length === 0" class="text-center p-8 text-gray-400">尚無資料</div></div>
            </div>

            <!-- Portfolio Tab -->
            <div v-if="currentTab === 'portfolio'" class="space-y-6 animate-fade-in">
                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">資產明細</h2><div class="flex items-center gap-2"><button @click="updateAllAssets" :disabled="isUpdatingAll" class="btn-secondary text-indigo-600"><i class="fa-solid fa-rotate mr-2" :class="{'fa-spin': isUpdatingAll}"></i>{{ isUpdatingAll ? '更新中...' : '更新現價' }}</button><button @click="openModal()" class="btn-primary shadow-md"><i class="fa-solid fa-plus mr-2"></i> 新增</button></div></div>
                <div class="card overflow-hidden p-0"><div class="overflow-x-auto"><table class="min-w-full text-sm text-left text-gray-500"><thead class="bg-gray-50 text-xs font-bold text-gray-700 uppercase"><tr><th class="px-6 py-4">項目</th><th class="px-6 py-4 text-right">單位/股數</th><th class="px-6 py-4 text-right">成本</th><th class="px-6 py-4 text-right">現價</th><th class="px-6 py-4 text-right">市值</th><th class="px-6 py-4 text-right">損益</th><th class="px-6 py-4 text-center">操作</th></tr></thead><tbody class="divide-y divide-gray-100 bg-white"><tr v-for="(asset, index) in assets" :key="index" class="hover:bg-slate-50 transition group" :class="{'asset-excluded': asset.includeInTotal === false}"><td class="px-6 py-4"><div class="font-bold text-gray-900">{{ asset.name }} <span v-if="asset.includeInTotal===false" class="badge-excluded">未計入</span></div><div class="flex items-center gap-2 mt-1"><span class="text-xs px-2 py-0.5 rounded-full" :class="getTypeColor(asset.type)">{{ getChineseType(asset.type) }}</span><span v-if="asset.ticker" class="text-xs text-pink-500 font-bold">{{asset.ticker}}</span></div></td><td class="px-6 py-4 text-right">{{ formatNumber(asset.shares) }}</td><td class="px-6 py-4 text-right">{{ formatNumber(asset.avgCost, 2) }}</td><td class="px-6 py-4 text-right"><div class="font-bold">{{ formatNumber(asset.currentPrice, 2) }}</div></td><td class="px-6 py-4 text-right font-bold text-slate-800">{{ formatNumber(calculateMarketValue(asset)) }}</td><td class="px-6 py-4 text-right"><div class="font-bold" :class="getProfitClass(asset)">{{ formatNumber(calculateProfitAmount(asset)) }}</div><div class="text-[10px]" :class="getProfitClass(asset)">{{ calculateProfitPercent(asset) }}%</div></td><td class="px-6 py-4 text-center"><button @click="openModal(asset, index)" class="text-indigo-400 hover:text-indigo-600 mr-2"><i class="fa-solid fa-pen"></i></button><button @click="removeAsset(index)" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td></tr></tbody></table></div></div>
            </div>

            <!-- History Tab -->
            <div v-if="currentTab === 'history'" class="space-y-6 animate-fade-in">
                <div class="flex justify-between items-end"><div><h2 class="text-2xl font-bold text-slate-800">年度回顧</h2></div><div class="flex gap-2"><button @click="openHistoryModal" class="btn-secondary">補登</button><button @click="recordCurrentHistory" class="btn-primary">記錄今年</button></div></div>
                <div class="card h-80"><canvas id="historyChart"></canvas></div>
                <div class="card overflow-hidden p-0"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="px-6 py-4">年份</th><th class="px-6 py-4 text-right">淨資產</th><th class="px-6 py-4 text-right">被動收入</th><th class="px-6 py-4 text-center">操作</th></tr></thead><tbody class="divide-y"><tr v-for="(rec, idx) in historyData" :key="rec.year"><td class="px-6 py-4 font-bold">{{ rec.year }}</td><td class="px-6 py-4 text-right text-indigo-600 font-bold">${{ formatNumber(rec.netWorth) }}</td><td class="px-6 py-4 text-right text-pink-600">${{ formatNumber(rec.passive) }}</td><td class="px-6 py-4 text-center"><button @click="deleteHistory(idx)" class="text-red-400"><i class="fa-solid fa-trash-can"></i></button></td></tr></tbody></table></div>
            </div>

            <!-- Settings Tab -->
            <div v-if="currentTab === 'settings'" class="space-y-6 animate-fade-in">
                <h2 class="text-2xl font-bold text-slate-800">系統設定</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card border-l-4 border-blue-500 shadow-md">
                        <h3 class="font-bold mb-4 text-slate-700 flex items-center"><i class="fa-solid fa-cloud mr-2 text-blue-500"></i> 雲端同步中心</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <div><p class="text-sm font-bold text-gray-600">連線狀態</p><p class="text-xs text-gray-400 mt-0.5" v-if="user">{{ user ? '已連線' : '未連線' }}</p></div>
                                <div class="flex items-center"><span class="status-dot" :class="user ? 'status-online' : 'status-offline'"></span></div>
                            </div>
                            
                            <!-- Sync ID Input -->
                            <div v-if="user" class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                                <label class="block text-xs font-bold text-indigo-700 mb-1">共用同步碼 (Sync ID)</label>
                                <div class="flex gap-2">
                                    <input v-model="syncId" type="text" placeholder="自訂代碼 (如手機號)" class="input-field border-indigo-300 font-mono text-center font-bold text-indigo-600">
                                    <button @click="saveSyncId" class="btn-secondary whitespace-nowrap bg-indigo-600 text-white border-none hover:bg-indigo-700 text-xs px-3">儲存</button>
                                </div>
                                <p class="text-[10px] text-indigo-500 mt-1">※ 電腦與手機需設定「相同的代碼」才能同步同一份資料。</p>
                            </div>

                            <div v-if="!user" class="space-y-3">
                                <textarea v-model="firebaseConfigInput" class="w-full p-3 border rounded-lg font-mono text-[10px] bg-gray-50 h-24 resize-none" placeholder='貼上 Firebase Config JSON: { "apiKey": "..." }'></textarea>
                                <button @click="connectCustomCloud" :disabled="isSyncing" class="w-full btn-primary"><span v-if="isSyncing">連線中...</span><span v-else>連接雲端</span></button>
                            </div>

                            <div v-else class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <button @click="saveToCloud" :disabled="isSyncing" class="btn-cloud relative overflow-hidden h-12"><div class="flex flex-col items-center"><span class="text-sm font-bold"><i class="fa-solid fa-cloud-upload-alt mr-1"></i> 上傳備份</span><span class="text-[10px] opacity-80">本機 ➔ 雲端</span></div></button>
                                    <button @click="loadFromCloud" :disabled="isSyncing" class="btn-secondary border-blue-200 text-blue-600 hover:bg-blue-50 relative overflow-hidden h-12"><div class="flex flex-col items-center"><span class="text-sm font-bold"><i class="fa-solid fa-cloud-download-alt mr-1"></i> 下載還原</span><span class="text-[10px] opacity-80">雲端 ➔ 本機</span></div></button>
                                </div>
                                <button @click="disconnectCloud" class="w-full py-2 text-xs text-red-400 hover:text-red-600 border border-transparent hover:border-red-100 rounded transition">中斷連線</button>
                            </div>
                            <p v-if="cloudMessage" class="text-xs text-center mt-2 bg-gray-100 p-2 rounded" :class="cloudMessage.includes('成功')?'text-green-600':'text-red-500'">{{ cloudMessage }}</p>
                        </div>
                    </div>
                    
                    <div class="card border-l-4 border-green-500">
                        <h3 class="font-bold mb-4 text-slate-700">檔案備份</h3>
                        <div class="flex gap-3"><button @click="exportData" class="w-1/2 btn-secondary"><i class="fa-solid fa-download mr-2"></i> 匯出檔案</button><button @click="triggerImport" class="w-1/2 btn-secondary"><i class="fa-solid fa-upload mr-2"></i> 匯入檔案</button></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Asset Modal -->
    <div v-if="showModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-r from-slate-800 to-slate-700 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold tracking-wide">{{ isEditing ? '編輯' : '新增' }}</h3><button @click="showModal = false" class="text-slate-400"><i class="fa-solid fa-times"></i></button></div>
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-5">
                <div><label class="input-label">類別</label><div class="grid grid-cols-4 gap-2"><button type="button" v-for="(label, key) in assetTypesMap" :key="key" @click="switchType(key)" :class="form.type === key ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-600'" class="py-2 text-xs rounded-lg font-medium transition">{{ label }}</button></div></div>
                <div v-if="form.type==='Lending'" class="bg-orange-50 p-3 rounded"><div><label class="input-label">名稱</label><input v-model="form.name" class="input-field"></div><div class="mt-2"><label class="input-label">金額</label><input v-model.number="form.shares" type="number" class="input-field"></div><div class="hidden">{{form.currentPrice=1}}{{form.avgCost=1}}</div></div>
                <div v-else class="space-y-3">
                    <div class="flex gap-2"><div class="w-1/3"><label class="input-label">代號</label><input v-model="form.ticker" @blur="fetchPriceForForm" class="input-field uppercase font-bold text-pink-600"></div><div class="w-2/3"><label class="input-label">名稱</label><input v-model="form.name" class="input-field"></div></div>
                    <div class="grid grid-cols-2 gap-2"><div><label class="input-label">數量/股數</label><input v-model.number="form.shares" type="number" class="input-field"></div><div><label class="input-label">成本</label><input v-model.number="form.avgCost" type="number" class="input-field"></div></div>
                    <div><label class="input-label text-pink-600">現價</label><input v-model.number="form.currentPrice" type="number" class="input-field border-pink-300 font-bold"></div>
                    
                    <div v-if="['Stock','ETF'].includes(form.type)" class="border-t border-dashed border-gray-300 pt-4">
                        <label class="text-sm font-bold text-slate-700 mb-2 block">配息明細設定</label>
                        <div class="w-full mb-3"><label class="input-label">頻率 (自動偵測)</label><select v-model="form.dividendFreq" class="input-field border-yellow-300" @change="resetDividendDetails"><option value="Annually">年配 (1次)</option><option value="Semi-Annually">半年配 (2次)</option><option value="Quarterly">季配 (4次)</option><option value="Monthly">月配 (12次)</option></select></div>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <div v-if="form.dividendFreq === 'Annually'" class="grid grid-cols-1"><div><label class="div-label">年度</label><input v-model.number="form.dividendDetails[0]" type="number" step="0.01" class="div-input"></div></div>
                            <div v-else-if="form.dividendFreq === 'Semi-Annually'" class="grid grid-cols-2 gap-4"><div><label class="div-label">上半年</label><input v-model.number="form.dividendDetails[0]" type="number" step="0.01" class="div-input"></div><div><label class="div-label">下半年</label><input v-model.number="form.dividendDetails[1]" type="number" step="0.01" class="div-input"></div></div>
                            <div v-else-if="form.dividendFreq === 'Quarterly'" class="grid grid-cols-4 gap-3"><div v-for="i in 4" :key="i"><label class="div-label">第{{i}}季</label><input v-model.number="form.dividendDetails[i-1]" type="number" step="0.01" class="div-input"></div></div>
                            <div v-else-if="form.dividendFreq === 'Monthly'" class="grid grid-cols-6 gap-2"><div v-for="i in 12" :key="i"><label class="div-label">{{i}}月</label><input v-model.number="form.dividendDetails[i-1]" type="number" step="0.01" class="div-input"></div></div>
                            <div class="mt-3 text-right text-xs text-gray-500 border-t border-yellow-100 pt-2">合計年配息: <span class="font-bold text-gray-800 text-base">${{ calculatedTotalDividend }}</span></div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mt-3"><label class="input-label mb-2 text-center">入帳月份 (勾選)</label><div class="grid grid-cols-6 gap-2"><button type="button" v-for="m in 12" :key="m" @click="toggleDividendMonth(m)" :style="form.dividendMonths && form.dividendMonths.includes(m) ? 'background-color: #ec4899; color: white; border-color: #ec4899;' : 'background-color: white; color: #6b7280; border-color: #e5e7eb;'" class="text-xs py-2 rounded-md transition select-none outline-none border hover:opacity-90">{{m}}月</button></div></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-between"><label class="flex items-center"><input type="checkbox" v-model="form.includeInTotal" class="mr-2">計入總資產</label><div class="flex gap-2"><button @click="showModal=false" class="btn-secondary">取消</button><button @click="saveAsset" class="btn-primary">儲存</button></div></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const { createApp, reactive, computed, ref, watch, onMounted, nextTick } = Vue;
    const STORAGE_KEY = 'myWealth_Master_DB';
    const OLD_KEYS = ['myWealthV73_Data', 'myWealthV72_Data'];
    const CONFIG_KEY = 'myWealth_Firebase_Config';
    const SYNC_ID_KEY = 'myWealth_Sync_ID';

    createApp({
        setup() {
            const currentTab = ref('dashboard');
            const showModal = ref(false);
            const showHistoryModal = ref(false);
            const isEditing = ref(false);
            const editingIndex = ref(-1);
            const isMobileMenuOpen = ref(false); // Mobile menu state
            const settings = reactive({ salary: 60000, usdRate: 32.5 });
            const assetTypesMap = { 'Stock': '股票', 'ETF': 'ETF', 'Bond': '直購債券', 'Crypto': '加密貨幣', 'Cash': '活/定存', 'Gold': '黃金', 'Lending': '外借款' };
            const bankList = ['國泰世華', '玉山銀行', '中國信託', '富邦銀行','華南銀行', '星展銀行', '郵局'];
            const form = reactive({ type: 'Stock', ticker: '', name: '', shares: 0, avgCost: 0, currentPrice: 0, yield: 0, currency: 'TWD', dividendFreq: 'Annually', dividendDetails: [0], dividendMonths: [], loading: false, isManual: false, includeInTotal: true });
            const historyForm = reactive({ year: new Date().getFullYear()-1, netWorth: 0, passive: 0 });
            const assets = ref([]);
            const historyData = ref([]); 
            let historyChart = null; 
            const isUpdatingAll = ref(false);
            let mainPieChart = null;
            let monthlyBarChart = null;
            const user = ref(null);
            const isSyncing = ref(false);
            const cloudMessage = ref('');
            const firebaseConfigInput = ref('');
            const syncId = ref(localStorage.getItem(SYNC_ID_KEY) || '');
            let db = null; let auth = null; let app = null; let appId = 'mymoney-8e727';

            // --- Missing Data Maps Restored ---
            const stockNameMap = {
                '0050': '元大台灣50', '0056': '元大高股息', '006208': '富邦台50', '00679B': '元大美債20年', '00713': '元大台灣高息低波',
                '00878': '國泰永續高股息', '00919': '群益台灣精選高息', '00929': '復華台灣科技優息', '00940': '元大台灣價值高息', '00939': '統一台灣高息動能',
                '2330': '台積電', '2303': '聯電', '2317': '鴻海', '2454': '聯發科', '2881': '富邦金', '2882': '國泰金',
                '2891': '中信金', '2886': '兆豐金', '2884': '玉山金', '2892': '第一金', '5880': '合庫金', '1101': '台泥', '1102': '亞泥',
                '1216': '統一', '1301': '台塑', '1303': '南亞', '2002': '中鋼', '2412': '中華電', '2603': '長榮', '2609': '陽明',
                '2615': '萬海', '2880': '華南金', '2883': '開發金', '2885': '元大金', '2887': '台新金', '2890': '永豐金', '3034': '聯詠',
                '3037': '欣興', '3231': '緯創', '3711': '日月光投控', '4904': '遠傳', '4938': '和碩', '5871': '中租-KY', '5876': '上海商銀',
                '6505': '台塑化', '9904': '寶成', 'BTC': '比特幣', 'ETH': '以太幣', 'USDT': '泰達幣'
            };
            const otcTickers = ['00679B', '00772B', '00751B', '00687B', '00720B', '00725B', '00740B', '00746B']; 
            const cryptoIdMap = { 
                'BTC': 'bitcoin', 'ETH': 'ethereum', 'USDT': 'tether', 'BNB': 'binancecoin', 
                'SOL': 'solana', 'XRP': 'ripple', 'DOGE': 'dogecoin', 'ADA': 'cardano' 
            };

            // Helpers & Calculations
            const formatNumber = (n, d = 0) => isNaN(n) ? '0' : Number(n).toLocaleString('en-US', { minimumFractionDigits: d, maximumFractionDigits: d });
            
            const formatUnit = (a) => { 
                if(['Stock','ETF'].includes(a.type)) return { main: `${parseFloat((a.shares/1000).toFixed(3))} 張`, sub: `(${a.shares})` }; 
                if(a.type === 'Crypto') return { main: `${formatNumber(a.shares, 4)} 顆`, sub: '' }; 
                return { main: formatNumber(a.shares), sub: '' }; 
            };
            
            const sumDividend = (d) => d && Array.isArray(d) ? d.reduce((a, b) => a + (Number(b) || 0), 0) : 0;
            
            const getBankColor = (b) => { 
                if(!b) return '#94a3b8'; 
                if(b.includes('國泰')) return '#00aa4e'; 
                if(b.includes('玉山')) return '#ef4c4c'; 
                if(b.includes('中信')) return '#008489'; 
                return '#64748b'; 
            };
            
            const getTypeColor = (t) => ({'Stock':'bg-red-100 text-red-700','ETF':'bg-purple-100 text-purple-700','Bond':'bg-blue-100 text-blue-700','Cash':'bg-green-100 text-green-700','Gold':'bg-yellow-100 text-yellow-700','Crypto':'bg-indigo-100 text-indigo-700', 'Lending': 'bg-orange-100 text-orange-700'}[t]);
            const getChineseType = (t) => assetTypesMap[t];
            const getFreqLabel = (f) => ({'Annually':'年配','Semi-Annually':'半年','Quarterly':'季配','Monthly':'月配'}[f]||f);
            
            const tabClass = (t) => currentTab.value === t ? 'flex items-center p-3 rounded-lg bg-slate-700 text-pink-400 border-l-4 border-pink-500 cursor-pointer transition' : 'flex items-center p-3 rounded-lg text-gray-400 hover:bg-slate-700 hover:text-white cursor-pointer transition';
            const isUSD = (a) => a.type === 'Bond' || (a.type === 'Crypto' && a.currency === 'USD');

            const calculateMarketValue = (a) => { let v = a.shares * a.currentPrice; if(a.type==='Bond') v = (a.currentPrice > 200 ? a.currentPrice : a.shares*(a.currentPrice/100)); if(isUSD(a)) v *= settings.usdRate; return v; };
            const calculateCost = (a) => { let v = a.shares * a.avgCost; if(a.type==='Bond') v = (a.avgCost > 200 ? a.avgCost : a.shares*(a.avgCost/100)); if(isUSD(a)) v *= settings.usdRate; return v; };
            const calculateAnnualIncome = (a) => { let inc = 0; if(a.type==='Bond') inc = a.shares*(a.yield/100); else if(a.type==='Cash') inc = a.shares*a.currentPrice*(a.yield/100); else if(['Stock','ETF'].includes(a.type)) { const td = sumDividend(a.dividendDetails); inc = td>0 ? td*a.shares : a.shares*a.currentPrice*(a.yield/100); } if(isUSD(a)) inc *= settings.usdRate; return inc; };
            const calculateProfitAmount = (a) => calculateMarketValue(a) - calculateCost(a);
            const calculateProfitPercent = (a) => { const c = calculateCost(a); return c===0 ? 0 : ((calculateMarketValue(a)-c)/c*100).toFixed(2); };
            const getProfitClass = (a) => { let v = calculateProfitAmount(a); return v>0?'text-up':(v<0?'text-down':'text-gray-400'); };

            const netWorth = computed(() => assets.value.filter(a => a.includeInTotal !== false).reduce((s, a) => s + calculateMarketValue(a), 0));
            const totalProfitLoss = computed(() => netWorth.value - assets.value.filter(a => a.includeInTotal !== false).reduce((s, a) => s + calculateCost(a), 0));
            const annualPassiveIncome = computed(() => assets.value.filter(a => a.includeInTotal !== false).reduce((s, a) => s + calculateAnnualIncome(a), 0));
            const calculatedTotalDividend = computed(() => form.dividendDetails ? form.dividendDetails.reduce((a, b) => a + (Number(b) || 0), 0).toFixed(2) : 0);
            
            const calculatedYield = computed(() => { 
                if (['Bond','Cash','Lending'].includes(form.type)) return (form.yield || 0) + '%'; 
                const t = parseFloat(calculatedTotalDividend.value); 
                return (!t || !form.currentPrice) ? '0%' : ((t / form.currentPrice) * 100).toFixed(2) + '%'; 
            });

            const monthlyIncomeData = computed(() => { 
                 let data = new Array(12).fill(0); 
                 assets.value.filter(a => a.includeInTotal !== false).forEach(a => { 
                     const incomeTWD = calculateAnnualIncome(a); 
                     if (incomeTWD > 0) { 
                         if (a.dividendMonths && a.dividendMonths.length > 0) { const amt = incomeTWD / a.dividendMonths.length; a.dividendMonths.forEach(m => { if (m >= 1 && m <= 12) data[m-1] += amt; }); } 
                         else { const amt = incomeTWD / 12; for(let i=0; i<12; i++) data[i] += amt; } 
                     } 
                 }); return data; 
             });
            const passiveIncomeList = computed(() => assets.value.filter(a => a.includeInTotal !== false).map(a => { const inc = calculateAnnualIncome(a); return { name: a.name, freq: getFreqLabel(a.dividendFreq), currency: (isUSD(a) || a.currency === 'USD') ? 'USD' : 'TWD', totalDiv: (a.type==='Bond'||a.type==='Cash')?a.yield:sumDividend(a.dividendDetails), annualIncome: inc, yield: a.yield }; }).filter(i => i.annualIncome > 0).sort((a,b) => b.annualIncome - a.annualIncome));

            const switchType = (t) => { form.type = t; if(t==='Cash'){form.ticker='TWD';form.currency='TWD';} else if(t==='Bond'){form.ticker='US-BOND';} else if(t==='Crypto'){form.currency='USD';} };
            const toggleDividendMonth = (m) => { if (!Array.isArray(form.dividendMonths)) form.dividendMonths = []; const idx = form.dividendMonths.indexOf(m); if (idx > -1) form.dividendMonths.splice(idx, 1); else form.dividendMonths.push(m); };
            const resetDividendDetails = () => { const count = { 'Annually': 1, 'Semi-Annually': 2, 'Quarterly': 4, 'Monthly': 12 }[form.dividendFreq] || 1; form.dividendDetails = Array(count).fill(0); };
            const openModal = (asset=null, idx=-1) => { if(asset) { isEditing.value=true; editingIndex.value=idx; const d = JSON.parse(JSON.stringify(asset)); if(d.includeInTotal===undefined) d.includeInTotal=true; if(!d.dividendMonths) d.dividendMonths=[]; if(!d.dividendDetails) d.dividendDetails=[0]; Object.assign(form, d); } else { isEditing.value=false; editingIndex.value=-1; Object.assign(form, {type:'Stock', ticker:'', name:'', shares:0, avgCost:0, currentPrice:0, yield:0, currency: 'USD', dividendFreq:'Annually', dividendDetails:[0], dividendMonths:[], loading: false, isManual: false, includeInTotal: true}); } showModal.value=true; };
            const saveAsset = () => { if(!Array.isArray(form.dividendMonths)) form.dividendMonths=[]; const d = JSON.parse(JSON.stringify(form)); if(isEditing.value) assets.value[editingIndex.value]=d; else assets.value.push(d); showModal.value=false; saveData(); };
            const removeAsset = (i) => { if(confirm('刪除?')){assets.value.splice(i,1); saveData();} };
            
            // Helper to close menu
            const selectTab = (tab) => {
                currentTab.value = tab;
                isMobileMenuOpen.value = false;
            };

            const fetchPriceDirect = (targetAsset, isForm = false) => {
                 const currentType = isForm ? form.type : targetAsset.type;
                 if(currentType === 'Bond' || currentType === 'Lending' || (isForm && form.isManual) || (!isForm && targetAsset.isManual)) return;

                 const fetchYahoo = () => {
                       let sym = (isForm ? form.ticker : targetAsset.ticker).trim().toUpperCase();
                       if(!sym) return;
                       
                       let url = '';
                       if(currentType === 'Crypto') {
                           const currency = (isForm ? form.currency : targetAsset.currency) || 'USD';
                           url = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}-${currency}?interval=1d`;
                       } else if(currentType === 'Gold') {
                           url = 'https://query1.finance.yahoo.com/v8/finance/chart/GC=F?interval=1d';
                       } else if(currentType === 'Cash') {
                           if(isForm) form.currentPrice = 1; 
                           return;
                       } else {
                           if(otcTickers.includes(sym)) {
                               if(!sym.includes('.TWO')) sym += '.TWO';
                           } else {
                               if(/^[0-9]/.test(sym) && !sym.includes('.TW') && !sym.includes('.')) sym += '.TW';
                           }
                           url = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d`;
                       }

                       const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                       if(isForm) form.loading = true;
                       
                       fetch(proxyUrl).then(r=>r.json()).then(d=>{
                            if(d.chart && d.chart.result) {
                                let res = d.chart.result[0];
                                let p = res.meta.regularMarketPrice || res.meta.chartPreviousClose;
                                
                                if(currentType === 'Gold' && settings.usdRate) {
                                    p = (p / 31.1035) * settings.usdRate;
                                }

                                if(isForm) { 
                                    if(!form.name) {
                                        const rawSym = sym.split('.')[0];
                                        form.name = stockNameMap[rawSym] || res.meta.shortName || res.meta.longName || rawSym;
                                    }
                                    form.currentPrice = p; 
                                    form.loading=false; 
                                } else { 
                                    targetAsset.currentPrice = p; 
                                    saveData(); 
                                }
                            } else if(isForm) form.loading=false;
                       }).catch(()=>{ if(isForm)form.loading=false; });
                 };
                 
                 if(currentType==='Crypto') {
                       const sym = (isForm ? form.ticker : targetAsset.ticker).toUpperCase();
                       const curr = (isForm ? form.currency : targetAsset.currency).toLowerCase();
                       const cgId = cryptoIdMap[sym];
                       if (cgId) {
                           if(isForm) form.loading=true;
                           fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${cgId}&vs_currencies=${curr}`).then(r=>r.json()).then(d=>{
                                if(d[cgId]){ 
                                    if(isForm) { form.currentPrice=d[cgId][curr]; form.loading=false; } 
                                    else { targetAsset.currentPrice=d[cgId][curr]; saveData(); } 
                                } else fetchYahoo();
                           }).catch(()=>fetchYahoo());
                       } else fetchYahoo();
                 } else fetchYahoo();
            };
            const fetchPriceForFormLocal = () => fetchPriceDirect(null, true);
            const fetchGlobalUSDRate = () => { fetch('https://corsproxy.io/?' + encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/USDTWD=X?interval=1d')).then(r=>r.json()).then(d=>{ if(d.chart && d.chart.result) { settings.usdRate = d.chart.result[0].meta.regularMarketPrice; saveData(); alert('匯率更新: ' + settings.usdRate); } }); };
            const updateAllAssets = async () => { isUpdatingAll.value = true; await Promise.all(assets.value.map(a => { if (!a.isManual && !['Bond','Lending'].includes(a.type)) return new Promise(r => { fetchPriceDirect(a, false); setTimeout(r, 500); }); return Promise.resolve(); })); isUpdatingAll.value = false; };

            const loadData = () => { let saved = localStorage.getItem(STORAGE_KEY); if (!saved) { for (let k of OLD_KEYS) { const o = localStorage.getItem(k); if (o) { saved = o; localStorage.setItem(STORAGE_KEY, saved); break; } } } if (saved) { const p = JSON.parse(saved); assets.value = p.assets || []; if(p.usdRate) settings.usdRate = p.usdRate; historyData.value = p.history || []; } };
            const saveData = () => localStorage.setItem(STORAGE_KEY, JSON.stringify({ assets: assets.value, usdRate: settings.usdRate, history: historyData.value }));
            const resetData = () => { if(confirm('Reset?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } };
            const handleFileUploadModule = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const d = JSON.parse(ev.target.result); assets.value = d.assets; historyData.value = d.history; settings.usdRate = d.usdRate; saveData(); location.reload(); } catch (err) { alert('匯入失敗'); } }; reader.readAsText(file); };
            const triggerImport = () => document.getElementById('fileInput').click();
            const exportData = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({ assets: assets.value, history: historyData.value, usdRate: settings.usdRate }, null, 2)], { type: "application/json" })); a.download = `myWealth_Backup.json`; a.click(); };
            const exportCSV = () => { let c = "Type,Name,Ticker,Shares,Cost,Price,Value\n"; assets.value.forEach(a => c += `${a.type},${a.name},${a.ticker},${a.shares},${a.avgCost},${a.currentPrice},${calculateMarketValue(a)}\n`); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], { type: "text/csv;charset=utf-8;" })); a.download = `myWealth.csv`; a.click(); };
            const forceMigrateData = () => { if(confirm('還原舊資料？')) { for(let i=73; i>=30; i--) { const k = `myWealthV${i}_Data`; const o = localStorage.getItem(k); if(o) { localStorage.setItem(STORAGE_KEY, o); location.reload(); return; } } alert('無舊資料'); } };
            const recordCurrentHistory = () => { const y = new Date().getFullYear(); const idx = historyData.value.findIndex(h => h.year === y); const r = { year: y, netWorth: netWorth.value, passive: annualPassiveIncome.value }; if (idx > -1) historyData.value[idx] = r; else historyData.value.push(r); saveData(); renderHistoryChart(); };
            const openHistoryModal = () => { historyForm.year = new Date().getFullYear()-1; showHistoryModal.value=true; };
            const saveHistoryRecord = () => { const idx = historyData.value.findIndex(h => h.year === historyForm.year); if (idx > -1) historyData.value[idx] = {...historyForm}; else historyData.value.push({...historyForm}); saveData(); showHistoryModal.value=false; renderHistoryChart(); };
            const deleteHistory = (i) => { historyData.value.splice(i, 1); saveData(); renderHistoryChart(); };

            // === Cloud Logic V91 ===
            const saveSyncId = () => { localStorage.setItem(SYNC_ID_KEY, syncId.value); alert('同步碼已儲存！'); };
            const initFirebase = async () => {
                const savedConfigStr = localStorage.getItem(CONFIG_KEY);
                let config = savedConfigStr ? JSON.parse(savedConfigStr) : (typeof __firebase_config!=='undefined'?JSON.parse(__firebase_config):null);
                if (!config && typeof __app_id === 'undefined') {
                     config = { 
                        apiKey: "AIzaSyBMZkTTRKgogrkSLfwrnmmMcUvZk5rSJ9w", 
                        authDomain: "mymoney-8e727.firebaseapp.com",
                        projectId: "mymoney-8e727",
                        appId: "1:697114335542:web:4036b6b490f028efcdbb97"
                     };
                }
                if (!config) return;
                appId = config.projectId || 'mymoney-8e727'; 
                try {
                    app = initializeApp(config);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    onAuthStateChanged(auth, (u) => { user.value = u; if(u) cloudMessage.value = "已連線"; });
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth);
                } catch (e) { 
                    console.error(e); 
                    if(e.message && e.message.includes('configuration-not-found')) cloudMessage.value = "請至 Firebase Console 開啟「匿名登入」";
                    else cloudMessage.value = "連線失敗"; 
                }
            };
            const connectCustomCloud = () => { try { const c = JSON.parse(firebaseConfigInput.value); localStorage.setItem(CONFIG_KEY, JSON.stringify(c)); location.reload(); } catch(e){ alert("JSON 錯誤"); } };
            const disconnectCloud = () => { if(confirm("確定中斷？")) { localStorage.removeItem(CONFIG_KEY); location.reload(); } };
            
            const saveToCloud = async () => {
                if (!user.value || !db) return;
                isSyncing.value = true; cloudMessage.value = '上傳中...';
                try {
                    const targetId = syncId.value || user.value.uid;
                    const docRef = doc(db, 'artifacts', appId, 'users', targetId, 'data', 'backup');
                    await setDoc(docRef, { assets: assets.value, history: historyData.value, settings: { usdRate: settings.usdRate }, updatedAt: new Date().toISOString() });
                    cloudMessage.value = `✅ 上傳成功 (ID: ${targetId.substring(0,6)}...)`;
                } catch (e) { cloudMessage.value = '❌ 上傳失敗'; } finally { isSyncing.value = false; }
            };
            const loadFromCloud = async () => {
                if (!user.value || !db || !confirm('確定覆蓋本機資料？')) return;
                isSyncing.value = true; cloudMessage.value = '下載中...';
                try {
                    const targetId = syncId.value || user.value.uid;
                    const docRef = doc(db, 'artifacts', appId, 'users', targetId, 'data', 'backup');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const d = docSnap.data(); assets.value = d.assets||[]; historyData.value = d.history||[]; if(d.settings?.usdRate) settings.usdRate = d.settings.usdRate;
                        saveData(); renderCharts(); cloudMessage.value = `✅ 下載成功 (ID: ${targetId.substring(0,6)}...)`;
                    } else cloudMessage.value = '⚠️ 雲端無資料';
                } catch (e) { cloudMessage.value = '❌ 下載失敗'; } finally { isSyncing.value = false; }
            };

            const renderHistoryChart = () => { nextTick(() => { const ctx = document.getElementById('historyChart'); if(!ctx) return; if(historyChart) historyChart.destroy(); historyChart = new Chart(ctx, { type: 'line', data: { labels: historyData.value.map(d => d.year), datasets: [{ label: '淨資產', data: historyData.value.map(d => d.netWorth), borderColor: '#4f46e5', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } }); }); };
            const renderCharts = () => { nextTick(() => { const ctx1 = document.getElementById('mainPieChart'); if(ctx1) { if(mainPieChart) mainPieChart.destroy(); const d = {}; assets.value.filter(a=>a.includeInTotal!==false).forEach(a => { let k = assetTypesMap[a.type]; if(!d[k])d[k]=0; d[k]+=calculateMarketValue(a); }); mainPieChart = new Chart(ctx1, { type: 'doughnut', data: { labels: Object.keys(d), datasets:[{ data: Object.values(d), backgroundColor:['#FCA5A5','#FDBA74','#FDE047','#86EFAC','#93C5FD', '#C7D2FE', '#fdba74']}] }, options: { responsive: true, maintainAspectRatio: false } }); } const ctx2 = document.getElementById('monthlyBarChart'); if(ctx2) { if(monthlyBarChart) monthlyBarChart.destroy(); monthlyBarChart = new Chart(ctx2, { type:'bar', data: { labels:Array.from({length:12},(_,i)=>i+1+'月'), datasets:[{label:'現金流', data:monthlyIncomeData.value, backgroundColor:'#F472B6', borderRadius:4}] }, options:{responsive:true,maintainAspectRatio:false} }); } if(currentTab.value === 'history') renderHistoryChart(); }); };

            onMounted(() => { initFirebase(); loadData(); renderCharts(); });
            watch([currentTab, assets, settings], () => { saveData(); renderCharts(); }, {deep:true});

            return { currentTab, showModal, isEditing, form, settings, assets, assetTypesMap, bankList, netWorth, annualPassiveIncome, totalProfitLoss, monthlyIncomeData, passiveIncomeList, switchType, openModal, saveAsset, removeAsset, toggleDividendMonth, formatNumber, formatUnit, getBankColor, getTypeColor, getChineseType, getFreqLabel, tabClass, getProfitClass, calculateCost, calculateMarketValue, calculateProfitAmount, calculateProfitPercent, fetchPriceForForm: fetchPriceForFormLocal, fetchPriceDirect, resetData, calculatedTotalDividend, calculatedYield, resetDividendDetails, sumDividend, forceMigrateData, isUSD, updateAllAssets, isUpdatingAll, fetchGlobalUSDRate, historyData, recordCurrentHistory, deleteHistory, showHistoryModal, historyForm, openHistoryModal, saveHistoryRecord, handleFileUpload: handleFileUploadModule, triggerImport, exportData, exportCSV, user, isSyncing, cloudMessage, saveToCloud, loadFromCloud, firebaseConfigInput, connectCustomCloud, disconnectCloud, syncId, saveSyncId, isMobileMenuOpen, selectTab };
        }
    }).mount('#app');
</script>
</body>
</html>
